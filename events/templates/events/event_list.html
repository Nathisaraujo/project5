{% extends "base.html" %}
{% load static %}

{% block page_header %}
    <div class="container header-container">
        <div class="row">
            <div class="col"></div>
        </div>
    </div>
{% endblock %}

{% block content %}
<div class="container-fluid mt-5 event-section">
  <div class="row text-center m-5">
      <h1 class="text-uppercase"><i class="fa-solid fa-calendar-days"></i><br>Events</h1>
      <p>Check out all of my events!<br>
        Here you'll discover all my hosted events. <br>
        You'll have access to event details such as the date, location, 
        and whether it's virtual or in-person. <br> <i class="fa-solid fa-circle-exclamation"></i> 
        If you register on the website, you can conveniently save events for future reference on your profile. <br>
        <i class="fa-solid fa-envelope"></i> You'll receive a friendly email reminder one day before the event!
      </p>
      <hr>
      {% if events %}
        {% for event in events %}
          <div class="col-3 mt-3" id="event-{{ event.pk }}">
            <div class="card event-card">
              <div class="card-body">
                <span class="text-uppercase">{{ event.title }}</span>
                <hr>
                <p>{{ event.description }}</p>
                <p><i class="fa-solid fa-id-badge"></i> Organizer: {{ event.organizer }}</p>
                <p><i class="fa-solid fa-calendar-days"></i> {{ event.date_and_time }}</p>
                <p><i class="fa-solid fa-location-dot"></i> {{ event.location }}</p>
                {% if event.date_and_time > now %}
                  <p><i class="fa-regular fa-clock"nn ,.></i> Remaining Time:<br><span id="countdown-{{ event.pk }}">{{ event.date_and_time }}</span></p>
                {% else %}
                  <p><span id="countdown-{{ event.pk }}">{{ event.date_and_time }}</span></p>
                {% endif %}
                
                {% now "Y-m-d H:i:s" as current_time %}
                {% if request.user.is_authenticated %}
                  {% if request.user in event.save_event.all %}
                    <form action="{% url 'unsave_event' event.id %}" method="post">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-dark"><i class="fa-solid fa-bookmark"></i> Saved</button>
                    </form>
                  {% else %}
                  {% if event.date_and_time|date:"Y-m-d H:i:s" > current_time %}
                    <form action="{% url 'save_event' event.id %}" method="post">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-dark"><i class="fa-regular fa-bookmark"></i> Save</button>
                    </form>
                    {% endif %}
                  {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-center">No events available at the moment.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Function to update countdown timer
    function updateCountdown(eventId, eventDateTime) {
      var eventDate = new Date(eventDateTime);
      var now = new Date();

      // Check if the event has already happened
      if (now > eventDate) {
        var countdownElement = document.getElementById('countdown-' + eventId);
        countdownElement.textContent = 'Event already happened';
        // If event already happened, remove the save button
        var saveButton = document.querySelector('#event-' + eventId + ' .save-button');
        if (saveButton) {
          saveButton.style.display = "none";
        }
      } else {
        var timeRemaining = eventDate - now;

        // Calculate remaining days, hours, minutes, and seconds
        var days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
        var hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);

        // Update countdown element
        var countdownElement = document.getElementById('countdown-' + eventId);
        countdownElement.textContent = days + ' days, ' + hours + ' hours, ' + minutes + ' minutes, ' + seconds + ' seconds';

        // Show the save button
        var saveButton = document.querySelector('#event-' + eventId + ' .save-button');
        if (saveButton) {
          saveButton.style.display = "block";
        }
      }
    }

    // Update countdown for each event
    function updateAllCountdowns() {
      var events = JSON.parse('{{ events_json|escapejs }}');
      events.forEach(function(event) {
        updateCountdown(event.pk, event.fields.date_and_time);
      });
    }

    // Update countdowns every second
    setInterval(updateAllCountdowns, 1000);
  });
</script>


{% endblock %}
